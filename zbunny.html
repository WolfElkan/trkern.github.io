<!doctype html>
<html>
<script src="https://trkern.github.io/3d/three.js"></script>
<script>

var bunverts = [[4.6, -2.75, 0.45], [4.65, -2.8, -1.15], [5, -3.15, -0.65], [-2.6, 2.75, -2.6], [-3.15, 2.55, -1.05], [-3.15, 3.7, -3.5], [-4.45, -1.1, -0.1], [-3.85, -0.15, -1.35], [-4.1, -0.2, 0.3], [-3.95, 0.9, 2.05], [-4.1, 2, 1.25], [-3.25, 1.3, 1.95], [-4.6, 0.05, -0.4], [0.2, 4.3, -2.8], [-1.45, 3.55, -1.7], [-1.85, 2.45, -1.55], [-3.35, -0.05, 2.05], [1.25, 0.95, -1.45], [1.9, 1.1, 0.05], [-0.55, 0.8, -0.45], [-3.75, 3.8, -4.05], [-2.3, 2.4, 0.85], [-1.85, 1.7, -0.95], [-1.85, 0.9, -1.4], [-1.5, 0.9, -0.15], [4.2, -4.15, -1.35], [-2.7, 0.55, 1.7], [1.1, -3.8, 2.2], [1.15, -3.1, 2.35], [1.95, -3.45, 2.05], [0.15, -4, 1.9], [2.15, -4.1, 1.55], [2, -4.9, -2.5], [0.1, -4.3, -2.9], [-1.45, -4.95, -3.1], [4.7, -4.05, 0.1], [3.2, -4.8, 0.15], [3.5, -3.6, -1.7], [2.65, -4.1, -2.4], [2.4, -4.9, -1.25], [1, -0.15, 1.5], [0.6, 0.8, 0.75], [2.35, 0.3, 1], [0.55, -0.75, 1.55], [-3.4, -1.3, 1.4], [-3.3, -0.4, 1.15], [-1.9, -0.8, 1.5], [-2, 0.15, 0.9], [-2.2, -1.5, 1.7], [-0.15, 3.05, -2.2], [-2.35, -3.35, -1.35], [-2.65, -2.35, -2.35], [-3.75, -2.5, -1.3], [1.6, -0.95, 1.9], [2.55, -0.85, 1.6], [-1.55, -2.4, 1.5], [-2.9, -2.15, 1.5], [1.75, -1.75, 2.3], [0.9, -2.35, 2.45], [-4.2, -1.75, -1.15], [-4.25, -1.9, 0.15], [-2.35, -4.8, 1.85], [-1.8, -3.95, 1.2], [-1.25, -4.75, 1.55], [3.6, -3.45, 0.9], [3.8, -4.2, 0.8], [0.35, 2.9, -1.8], [0.7, 3.65, -3], [-0.8, 0.35, 0.7], [-1.25, -1.15, 1.5], [-0.75, -2, 1.4], [-0.55, -3.6, 1.05], [-0.4, -0.85, 1.6], [-2.75, -4.9, 0.05], [-1.95, -4.15, -0.05], [-2.85, -4.3, 0.85], [4, -2.6, 0.25], [0.15, -1.2, 2.25], [-2.9, 2.35, -3.85], [-2.6, 3.35, -4.95], [-3.15, 2.45, -4.35], [-0.25, -1.95, 2.3], [0.15, -3.1, 2.1], [3.9, -1.4, 0.3], [-2.65, 1.45, 1.05], [2.3, -4.75, 1.45], [-1.5, 2.65, -0.75], [-2.05, 2.55, -0.4], [-0.45, 4.25, -1.6], [-2, 1.35, 0.65], [-4.3, 0.85, -1.2], [-4.4, 1.45, -0.1], [-4.65, 0.5, 0.45], [2.7, -2, 1.85], [3.95, -0.95, -0.95], [3.35, -1.5, 1.3], [0.2, 4.05, -2.4], [-0.35, -4.85, 2.15], [2.55, -3.35, 1.7], [-2.25, -3.55, -0.55], [-2.4, -4, -0.75], [-0.5, -4.3, 2.2], [3.2, 0, 0.6], [-2, -3.15, 0.9], [-2.75, 1.75, -1.65], [4.05, -2.55, -0.95], [3.45, -1.65, -2.25], [3.05, -2.45, -2.45], [-0.5, -3.85, -2.7], [-1, -4.3, -3], [-0.65, -4.9, -0.1], [-0.85, -4.85, 0.95], [-0.45, -4.7, -0.2], [3.2, -0.4, -1.85], [-3.5, 1.8, -1.6], [-4.55, 2.2, -0.05], [-3.6, 2.35, -1.5], [1.45, -1.25, -3.2], [2.3, -0.95, -2.6], [2.45, -3.65, -2.85], [-2.65, 2.45, -1.1], [3, 0.4, -1.15], [-3.6, -2.6, 0.65], [-1.8, -2.8, -2.1], [-3.45, 2.65, 0.4], [-2.95, 4.2, -4.85], [-3.9, -1.4, -1.8], [-2.35, -3.4, 0.1], [-2, -3.6, 0], [-0.2, -1, -2.7], [-1.25, -1.6, -2.6], [-0.95, -2.1, -2.9], [-0.8, -3.8, -1.85], [-4.55, 0.05, 1.45], [-0.75, -4.9, 1.4], [-2.95, -4.85, 1.25], [-0.35, -0.3, -2.45], [-1.4, -0.5, -2.45], [0.05, -3, -3.55], [-0.45, -1.45, -3.4], [-3.35, -4.55, -0.8], [1.5, -4.6, -1.9], [-0.65, -4.7, -0.95], [-3.25, -4.95, -1.5], [-1.9, -4.95, -2], [-2.15, -4.05, -1.55], [-3.35, 3.25, -3.85], [-0.45, 0.45, -1.6], [-3.45, 2.2, -2.8], [1.55, 0.2, -2.3], [1.85, -4.9, -2.05], [-0.9, -4.85, -2.4], [1.45, -0.8, -2.55], [-1.5, -4.95, 0.5], [0.35, -1.85, -3.65], [-2.75, 0.35, -1.75], [-2.35, -0.7, -2.45], [-1.5, 0.65, -1.85], [-0.5, -4.65, 1.15], [-1, -4.85, 0.1], [-0.85, -4.95, -0.6], [-0.85, -4.7, -1.2], [1.9, -2.7, -3.15], [1.25, -3.9, -3.1], [1.65, -4.9, 0.4], [1.6, -4.95, 1.15], [1.7, -4.85, 0], [2.3, -4.9, 0.2], [0.55, -4.8, 1.45], [0.15, -4.9, 1.6], [1.6, -4.6, 0.85], [0.9, -4.75, -0.5], [1.1, -4.9, 1.3], [2.55, -4.9, -0.45], [2.35, -4.8, -0.85], [0.85, -4.6, 1.1], [1.65, -4.75, -0.95], [-3.15, -3.3, -0.25], [-2.15, -4.95, -0.3], [-1.35, -5, -1.3], [-1.95, -4.9, 0.45], [0.35, -4.6, 1.25], [-1.05, -4.75, -1.5], [-1.15, -4.95, -0.95], [-1.8, -4.85, -0.65], [-1.25, -4.9, -0.45]];
var bunfaces = [[0,1,2],[3,4,5],[6,7,8],[9,10,11],[12,8,7],[13,14,15],[9,11,16],[17,18,19],[5,4,20],[10,21,11],[22,23,24],[1,25,2],[11,26,16],[27,28,29],[30,27,31],[32,33,34],[35,25,36],[37,38,39],[40,41,42],[40,42,43],[44,45,46],[45,47,46],[44,46,48],[41,19,18],[49,13,15],[50,51,52],[53,42,54],[48,55,56],[53,57,58],[59,6,60],[26,47,45],[58,57,28],[46,55,48],[61,62,63],[64,65,36],[66,67,49],[46,47,68],[47,24,68],[46,69,55],[46,68,69],[62,55,70],[62,71,63],[62,70,71],[69,70,55],[28,57,29],[69,68,72],[69,72,70],[73,74,75],[53,54,57],[72,68,41],[19,41,68],[64,76,0],[65,64,0],[43,72,40],[40,72,41],[77,53,58],[78,79,80],[81,58,82],[77,58,81],[43,42,53],[82,27,30],[27,82,28],[58,28,82],[83,76,64],[45,16,26],[11,84,26],[11,21,84],[35,2,25],[31,64,85],[86,87,88],[26,84,89],[90,91,92],[93,29,57],[84,21,89],[85,64,36],[26,89,47],[83,94,76],[0,35,65],[54,95,93],[89,24,47],[13,49,67],[66,86,96],[86,88,96],[97,30,31],[29,98,31],[50,99,100],[87,86,22],[93,98,29],[101,30,97],[93,95,64],[102,83,95],[98,93,64],[64,95,83],[54,102,95],[86,66,22],[24,89,22],[98,64,31],[31,27,29],[74,103,62],[104,3,78],[105,106,107],[108,109,33],[110,111,112],[39,38,32],[94,113,106],[90,92,12],[114,115,91],[114,116,115],[3,79,78],[117,106,118],[37,119,38],[105,94,106],[120,3,104],[115,10,91],[90,114,91],[37,107,119],[105,107,37],[74,73,100],[121,18,17],[96,67,66],[83,102,94],[89,21,22],[76,94,105],[0,2,35],[87,22,21],[52,60,122],[121,113,94],[1,0,76],[1,76,105],[123,51,50],[21,10,124],[4,124,116],[87,124,120],[68,24,19],[120,4,3],[87,21,124],[10,115,124],[120,124,4],[102,121,94],[96,13,67],[124,115,116],[5,125,79],[102,18,121],[96,88,13],[53,77,43],[22,49,15],[102,42,18],[5,79,3],[19,24,23],[126,6,59],[42,41,18],[5,20,125],[61,75,62],[127,103,128],[70,72,81],[55,62,103],[48,56,44],[71,82,30],[103,74,128],[20,4,116],[30,101,71],[72,77,81],[43,77,72],[129,130,131],[130,123,132],[63,71,101],[9,16,133],[70,81,71],[99,128,74],[81,82,71],[61,63,134],[135,75,61],[8,45,44],[6,44,60],[6,8,44],[136,137,130],[10,9,133],[136,130,129],[138,139,131],[88,87,120],[100,73,140],[60,44,56],[99,74,100],[141,142,112],[143,144,145],[20,146,125],[125,146,80],[91,10,92],[17,19,147],[138,131,108],[146,116,80],[74,62,75],[131,139,129],[146,20,116],[148,80,116],[108,132,109],[130,132,108],[118,106,113],[34,109,132],[148,116,114],[13,88,14],[14,88,120],[66,49,22],[17,136,149],[10,133,92],[140,145,100],[141,150,151],[59,60,52],[145,50,100],[126,7,6],[90,12,7],[104,22,120],[121,149,113],[139,117,152],[153,134,111],[139,154,117],[149,152,113],[155,156,157],[155,157,23],[136,17,147],[117,118,152],[152,118,113],[104,23,22],[157,156,137],[139,152,129],[19,23,157],[102,54,42],[149,121,17],[112,111,158],[159,110,160],[157,136,147],[157,137,136],[157,147,19],[155,7,156],[155,114,90],[155,90,7],[105,37,1],[25,1,37],[104,155,23],[130,51,123],[80,79,125],[156,7,126],[51,156,126],[37,39,25],[132,123,145],[132,145,144],[153,111,110],[54,93,57],[141,161,142],[107,162,119],[162,107,106],[132,144,34],[38,119,32],[106,117,162],[31,85,97],[59,52,126],[162,163,119],[163,33,119],[32,119,33],[162,138,163],[162,117,154],[14,120,15],[154,138,162],[22,15,120],[149,129,152],[163,138,33],[137,156,130],[145,140,143],[32,151,150],[33,109,34],[104,114,155],[123,50,145],[33,138,108],[51,126,52],[138,154,139],[130,156,51],[131,130,108],[153,110,159],[164,165,85],[166,164,167],[78,80,104],[80,148,104],[164,85,167],[97,85,165],[168,169,97],[165,164,170],[164,171,170],[168,97,172],[92,8,12],[173,167,36],[63,97,134],[92,133,8],[39,173,36],[167,85,36],[150,171,39],[174,173,39],[171,175,170],[141,112,171],[176,174,39],[133,45,8],[134,97,169],[39,36,25],[122,177,52],[45,133,16],[122,60,56],[32,150,39],[177,50,52],[171,176,39],[104,148,114],[143,140,73],[50,177,99],[97,63,101],[129,149,136],[172,97,165],[143,73,144],[122,103,177],[177,127,99],[177,103,127],[122,56,103],[144,73,178],[135,73,75],[171,166,176],[34,144,151],[144,178,179],[151,144,179],[73,135,178],[135,180,178],[135,61,180],[171,181,175],[179,182,151],[179,178,183],[184,160,178],[56,55,103],[183,178,160],[184,185,160],[112,158,171],[158,181,171],[171,150,141],[32,34,151],[151,182,161],[153,180,134],[180,61,134],[141,151,161],[171,164,166],[36,65,35],[185,159,160],[128,99,127],[134,158,111],[169,158,134],[158,169,181],[169,168,181],[181,168,175],[168,172,175],[175,172,170],[165,170,172],[182,179,183],[161,182,183],[183,160,161],[161,160,142],[112,142,160],[160,110,112]];

var cubeverts = [
	[1,1,1],
	[1,1,-1],
	[1,-1,-1],
	[1,-1,1],
	[-1,1,1],
	[-1,1,-1],
	[-1,-1,-1],
	[-1,-1,1]
	];

var cubefaces = [
	[3,2,1,0],
	[4,5,6,7],
	[0,1,5,4],
	[7,6,2,3],
	[1,2,6,5],
	[4,7,3,0]
	];

var cubenorms = [
	[1,0,0],
	[-1,0,0],
	[0,1,0],
	[0,-1,0],
	[0,0,-1],
	[0,0,1]
	];


function vec_sub(v1,v2) {
	var i;
	var rval = [];
	for (i = 0; i < v1.length; i++) {
		rval.push(v1[i]-v2[i]);
		}
	return(rval);
	}

function vec_cross(a,b) {
	return([
		a[1]*b[2]-a[2]*b[1],
		a[2]*b[0]-a[0]*b[2],
		a[0]*b[1]-a[1]*b[0]
		]);
	}

function make_normals() {
	var l = [];
	for (i = 0; i < cubefaces.length; i++) {
		var v0 = cubeverts[cubefaces[i][0]];
		var v1 = cubeverts[cubefaces[i][1]];
		var v2 = cubeverts[cubefaces[i][2]];
		var v3 = cubeverts[cubefaces[i][3]];
		l.push(vec_cross(vec_sub(v1,v0),vec_sub(v2,v0)));
		}
	return(l);
	}


function x_g_to_c(x) {
	return(50*(x+5));
	}

function y_g_to_c(y) {
	return(50*(-y+5));
	}

function convert_a_to_b(x,a_min,a_max,b_min,b_max) {
	return(((x-a_min)/(a_max-a_min))*(b_max-b_min) + b_min);
	}

function rotation_matrix_x(theta) {
	return(new THREE.Matrix3().set(
		Math.cos(theta),0,-Math.sin(theta),
		0,1,0,
		Math.sin(theta),0,Math.cos(theta)
		));
	}

function rotation_matrix_y(theta) {
	return(new THREE.Matrix3().set(
		1,0,0,
		0,Math.cos(theta),-Math.sin(theta),
		0,Math.sin(theta),Math.cos(theta)
		));
	}

function draw_ortho() {
	var xrot = Number(document.getElementById("xrot").value);
	var yrot = Number(document.getElementById("yrot").value);
	var ctx = document.getElementById("canvas").getContext("2d");
	ctx.clearRect(0,0,500,500);
	var i, j;
	for (i = 0; i < bunfaces.length; i++) {
		ctx.beginPath();
		for (j = 0; j <= 3; j++) {
			var v = new THREE.Vector3(...bunverts[bunfaces[i][j%3]]);
			v = applyMatrix3(rotation_matrix_x(xrot),v);
			v = applyMatrix3(rotation_matrix_y(yrot),v);
			//ctx.lineTo(v.x,v.y);
			ctx.lineTo(x_g_to_c(v.x),y_g_to_c(v.y));
			}
		ctx.stroke();
		}
	}

var face_colors = ["red","green","blue","cyan","magenta","yellow"];

function draw_cube_persp() {
	var xrot = Number(document.getElementById("xrot").value);
	var yrot = Number(document.getElementById("yrot").value);
	var ctx = document.getElementById("canvas").getContext("2d");
	ctx.clearRect(0,0,500,500);
	var i, j;
	for (i = 0; i < cubefaces.length; i++) {
		var vn = new THREE.Vector3(...cubenorms[i]);
		vn = applyMatrix3(rotation_matrix_x(xrot),vn);
		vn = applyMatrix3(rotation_matrix_y(yrot),vn);
		var vc = new THREE.Vector3(...cubeverts[cubefaces[i][0]]);
		vc = applyMatrix3(rotation_matrix_x(xrot),vc);
		vc = applyMatrix3(rotation_matrix_y(yrot),vc);
		vc.add(new THREE.Vector3(0,0,2));		
		if (vn.dot(vc) > 0) {continue;}
		//console.log(vn);
		//if (vn.z > 0) {continue;}
		ctx.beginPath();
		for (j = 0; j <= 4; j++) {
			var v = new THREE.Vector3(...cubeverts[cubefaces[i][j%4]]);
			v = applyMatrix3(rotation_matrix_x(xrot),v);
			v = applyMatrix3(rotation_matrix_y(yrot),v);
			//ctx.lineTo(v.x,v.y);
			v.add(new THREE.Vector3(0,0,2));
			v = project(v);
			ctx.lineTo(x_g_to_c(v.x),y_g_to_c(v.y));
			}
		ctx.fillStyle = face_colors[i];
		ctx.fill();
		ctx.stroke();
		ctx.beginPath();
		}
	}



function draw_persp_bunny() {
	var xrot = Number(document.getElementById("xrot").value);
	var yrot = Number(document.getElementById("yrot").value);
	var ctx = document.getElementById("canvas").getContext("2d");
	ctx.clearRect(0,0,500,500);
	var i, j;
	for (i = 0; i < bunfaces.length; i++) {
		var v0 = bunverts[bunfaces[i][0]];
		var v1 = bunverts[bunfaces[i][1]];
		var v2 = bunverts[bunfaces[i][2]];
		var w0 = new THREE.Vector3(...v0);
		var w1 = new THREE.Vector3(...v1);
		var w2 = new THREE.Vector3(...v2);
		w0.applyMatrix3(rotation_matrix_x(xrot));
		w0.applyMatrix3(rotation_matrix_y(yrot));
		w1.applyMatrix3(rotation_matrix_x(xrot));
		w1.applyMatrix3(rotation_matrix_y(yrot));
		w2.applyMatrix3(rotation_matrix_x(xrot));
		w2.applyMatrix3(rotation_matrix_y(yrot));
		w0.z += 7;
		w1.z += 7;
		w2.z += 7;
		var side1 = new THREE.Vector3().subVectors(w1,w0);
		var side2 = new THREE.Vector3().subVectors(w2,w0);
		var vn = new THREE.Vector3().crossVectors(side1,side2);
		if (vn.dot(w0) < 0) {continue;}
		w0 = project(w0);
		w1 = project(w1);
		w2 = project(w2);
		var v0x = convert_a_to_b(w0.x, -2, 2, 0, 500);
		var v0y = convert_a_to_b(w0.y, -2, 2, 500, 0);
		var v1x = convert_a_to_b(w1.x, -2, 2, 0, 500);
		var v1y = convert_a_to_b(w1.y, -2, 2, 500, 0);
		var v2x = convert_a_to_b(w2.x, -2, 2, 0, 500);
		var v2y = convert_a_to_b(w2.y, -2, 2, 500, 0);
		console.log(v0x,v0y,v1x,v1y,v2x,v2y);
		ctx.beginPath();
		ctx.moveTo(v0x, v0y);
		ctx.lineTo(v1x, v1y);
		ctx.lineTo(v2x, v2y);
		ctx.lineTo(v0x, v0y);
		ctx.stroke();
		ctx.fillStyle = "hsla("+i+",100%,50%,1)";
		ctx.fill();		
		}
	}

function set_rgba(imagedata,x,y,r,g,b,a) {
	var pos = y*imagedata.width+x;
	imagedata.data[pos*4] = r;
	imagedata.data[pos*4+1] = g;
	imagedata.data[pos*4+2] = b;
	imagedata.data[pos*4+3] = a;
	}

function HSL_to_RGB(H,S,L) {
	var R,G,B;
	var C;
	if (L <= .5) {
		C = S*2*L;
		}
	else {
		C = S*2*(1-L);
		}
	var max = L+C/2;
	var min = L-C/2;
	if (H < 60) {
		R = max;
		G = convert_a_to_b(H,0,60,min,max);
		B = min;
		}
	else if (H < 120) {
		R = convert_a_to_b(H,60,120,max,min);
		G = max;
		B = min;
		}
	else if (H < 180) {
		R = min;
		G = max;
		B = convert_a_to_b(H,120,180,min,max);
		}
	else if (H < 240) {
		R = min;
		G = convert_a_to_b(H,180,240,max,min);
		B = max;
		}
	else if (H < 300) {
		R = convert_a_to_b(H,240,300,min,max);
		G = min;
		B = max;
		}
	else {
		R = max;
		G = min;
		B = convert_a_to_b(H,300,360,max,min);
		}
	return([255*R,255*G,255*B]);
	}

var zbuffer;

function draw_persp_bunny_zbuff() {
	var x,y;
	zbuffer = [];
	for (x = 0; x < 500; x++) {
		zbuffer.push([]);
		for (y = 0; y < 500; y++) {
			zbuffer[x].push(Infinity);
			}
		}
	var xrot = Number(document.getElementById("xrot").value);
	var yrot = Number(document.getElementById("yrot").value);
	var ctx = document.getElementById("canvas").getContext("2d");
	ctx.clearRect(0,0,500,500);
	var imagedata = ctx.getImageData(0,0,500,500);
	var ctx2 = document.getElementById("z").getContext("2d");
	ctx2.clearRect(0,0,500,500);
	var imagedata2 = ctx2.getImageData(0,0,500,500);
	var i, j;
	for (i = 0; i < bunfaces.length; i++) {
		var v0 = bunverts[bunfaces[i][0]];
		var v1 = bunverts[bunfaces[i][1]];
		var v2 = bunverts[bunfaces[i][2]];
		var w0 = new THREE.Vector3(...v0);
		var w1 = new THREE.Vector3(...v1);
		var w2 = new THREE.Vector3(...v2);
		w0.applyMatrix3(rotation_matrix_x(xrot));
		w0.applyMatrix3(rotation_matrix_y(yrot));
		w1.applyMatrix3(rotation_matrix_x(xrot));
		w1.applyMatrix3(rotation_matrix_y(yrot));
		w2.applyMatrix3(rotation_matrix_x(xrot));
		w2.applyMatrix3(rotation_matrix_y(yrot));
		w0.z += 7;
		w1.z += 7;
		w2.z += 7;
		var side1 = new THREE.Vector3().subVectors(w1,w0);
		var side2 = new THREE.Vector3().subVectors(w2,w0);
		var vn = new THREE.Vector3().crossVectors(side1,side2);
		//if (vn.dot(w0) < 0) {continue;}
		var w0p = project(w0);
		var w1p = project(w1);
		var w2p = project(w2);
		var v0x = convert_a_to_b(w0p.x, -2, 2, 0, 500);
		var v0y = convert_a_to_b(w0p.y, -2, 2, 500, 0);
		var v1x = convert_a_to_b(w1p.x, -2, 2, 0, 500);
		var v1y = convert_a_to_b(w1p.y, -2, 2, 500, 0);
		var v2x = convert_a_to_b(w2p.x, -2, 2, 0, 500);
		var v2y = convert_a_to_b(w2p.y, -2, 2, 500, 0);
		var minx = Math.round(Math.max(0,Math.min(v0x,v1x,v2x)));
		var maxx = Math.round(Math.min(499,Math.max(v0x,v1x,v2x)));
		var miny = Math.round(Math.max(0,Math.min(v0y,v1y,v2y)));
		var maxy = Math.round(Math.min(499,Math.max(v0y,v1y,v2y)));
		for (x = minx; x <= maxx; x++) {
			for (y = miny; y <= maxy; y++) {
				var answer = solve_pixel_t(x,y,w0,w1,w2);
				if (answer == null) {continue;}
				var t = answer.t;
				if (t > zbuffer[x][y]) {continue;}
				zbuffer[x][y] = t;
				//set_rgba(imagedata,x,y,t*20,answer.u*255,answer.v*255,255);
				set_rgba(imagedata,x,y,...HSL_to_RGB(i,1,.5),255);
				var g = convert_a_to_b(t,0,20,0,255);
				set_rgba(imagedata2,x,y,g,g,g,255);
				}
			}
		}

	ctx.putImageData(imagedata,0,0);
	ctx2.putImageData(imagedata2,0,0);
/*	ctx.lineWidth = 5;
	for (i = 0; i < bunfaces.length; i++) {
		var v0 = bunverts[bunfaces[i][0]];
		var v1 = bunverts[bunfaces[i][1]];
		var v2 = bunverts[bunfaces[i][2]];
		var w0 = new THREE.Vector3(...v0);
		var w1 = new THREE.Vector3(...v1);
		var w2 = new THREE.Vector3(...v2);
		w0.applyMatrix3(rotation_matrix_x(xrot));
		w0.applyMatrix3(rotation_matrix_y(yrot));
		w1.applyMatrix3(rotation_matrix_x(xrot));
		w1.applyMatrix3(rotation_matrix_y(yrot));
		w2.applyMatrix3(rotation_matrix_x(xrot));
		w2.applyMatrix3(rotation_matrix_y(yrot));
		w0.z += 7;
		w1.z += 7;
		w2.z += 7;
		var side1 = new THREE.Vector3().subVectors(w1,w0);
		var side2 = new THREE.Vector3().subVectors(w2,w0);
		var vn = new THREE.Vector3().crossVectors(side1,side2);
		if (vn.dot(w0) < 0) {continue;}
		var w0p = project(w0);
		var w1p = project(w1);
		var w2p = project(w2);
		var v0x = convert_a_to_b(w0p.x, -2, 2, 0, 500);
		var v0y = convert_a_to_b(w0p.y, -2, 2, 500, 0);
		var v1x = convert_a_to_b(w1p.x, -2, 2, 0, 500);
		var v1y = convert_a_to_b(w1p.y, -2, 2, 500, 0);
		var v2x = convert_a_to_b(w2p.x, -2, 2, 0, 500);
		var v2y = convert_a_to_b(w2p.y, -2, 2, 500, 0);
		console.log(v0x,v0y);
		ctx.beginPath();
		ctx.moveTo(v0x, v0y);
		ctx.lineTo(v1x, v1y);
		ctx.lineTo(v2x, v2y);
		ctx.lineTo(v0x, v0y);
		ctx.stroke();
		}*/
	}

function solve_pixel_t(cx,cy,w0,w1,w2) {
	var x = convert_a_to_b(cx, 0, 500, -2, 2);
	var y = convert_a_to_b(cy, 500, 0, -2, 2);
	var side1 = new THREE.Vector3().subVectors(w1,w0);
	var side2 = new THREE.Vector3().subVectors(w2,w0);
	var m = new THREE.Matrix3().set(
		x, -side1.x, -side2.x,
		y, -side1.y, -side2.y,
		1, -side1.z, -side2.z
		);
	if (m.determinant() == 0) {return(null);}
	var answer = w0.clone().applyMatrix3(m.invert());
	var t = answer.x;
	var u = answer.y;
	var v = answer.z;
	if (u < 0 || v < 0 || u + v > 1) {return(null);}
	if (t < 0) {return(null);}
	return({t:t,u:u,v:v});
	}

function draw_bunny_persp_old() {
	var xrot = Number(document.getElementById("xrot").value);
	var yrot = Number(document.getElementById("yrot").value);
	var ctx = document.getElementById("canvas").getContext("2d");
	ctx.clearRect(0,0,500,500);
	var i, j;
	for (i = 0; i < bunfaces.length; i++) {
		var vn = new THREE.Vector3(...cubenorms[i]);
		vn = 
		vn = applyMatrix3(rotation_matrix_x(xrot),vn);
		vn = applyMatrix3(rotation_matrix_y(yrot),vn);
		var vc = new THREE.Vector3(...cubeverts[cubefaces[i][0]]);
		vc = applyMatrix3(rotation_matrix_x(xrot),vc);
		vc = applyMatrix3(rotation_matrix_y(yrot),vc);
		vc.add(new THREE.Vector3(0,0,2));		
		if (vn.dot(vc) > 0) {continue;}
		//console.log(vn);
		//if (vn.z > 0) {continue;}
		ctx.beginPath();
		for (j = 0; j <= 4; j++) {
			var v = new THREE.Vector3(...cubeverts[cubefaces[i][j%4]]);
			v = applyMatrix3(rotation_matrix_x(xrot),v);
			v = applyMatrix3(rotation_matrix_y(yrot),v);
			//ctx.lineTo(v.x,v.y);
			v.add(new THREE.Vector3(0,0,2));
			v = project(v);
			ctx.lineTo(x_g_to_c(v.x),y_g_to_c(v.y));
			}
		ctx.fillStyle = face_colors[i];
		ctx.fill();
		ctx.stroke();
		ctx.beginPath();
		}
	}

function project(v) {
	return(new THREE.Vector3(v.x/v.z,v.y/v.z,1));
	}

function applyMatrix3(mat,v) {
	var m = mat.toArray();
	return(new THREE.Vector3(
		m[0]*v.x + m[3]*v.y + m[6]*v.z,
		m[1]*v.x + m[4]*v.y + m[7]*v.z,
		m[2]*v.x + m[5]*v.y + m[8]*v.z
		));
	}

function ribet(mn,mx) {
	return(Math.floor(Math.random()*(mx-mn+1))+mn);
	}

function testapplymatrix3() {
	var m = new THREE.Matrix3();
	m.set(ribet(-5,5),ribet(-5,5),ribet(-5,5),ribet(-5,5),ribet(-5,5),ribet(-5,5),ribet(-5,5),ribet(-5,5),ribet(-5,5));
	console.log(m.toArray());
	var v = new THREE.Vector3(ribet(-5,5),ribet(-5,5),ribet(-5,5));
	console.log(applyMatrix3(m,v).toArray());
	v.applyMatrix3(m);
	console.log(v);
	console.log("###");
	}
</script>
<head>
</head>
<body onload="draw_persp_bunny_zbuff()">
<canvas id="canvas" width=500 height=500 style="border: 1px solid"></canvas>
<input type="range" id="xrot" value=7 oninput="draw_persp_bunny_zbuff()" min=0 max=6.28 step=.01>
<input type="range" id="yrot" value=7 oninput="draw_persp_bunny_zbuff()" min=0 max=6.28 step=.01>
<canvas id="z" width=500 height=500 style="border:1px solid"></canvas>
</body>
</html>