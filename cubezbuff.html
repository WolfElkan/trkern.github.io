<!doctype html>
<html>
<head>
<script src="three.min.js"></script>
<script>

var bunverts = [[0.45, -2.75, 4.6], [-1.15, -2.8, 4.65], [-0.65, -3.15, 5], [-2.6, 2.75, -2.6], [-1.05, 2.55, -3.15], [-3.5, 3.7, -3.15], [-0.1, -1.1, -4.45], [-1.35, -0.15, -3.85], [0.3, -0.2, -4.1], [2.05, 0.9, -3.95], [1.25, 2, -4.1], [1.95, 1.3, -3.25], [-0.4, 0.05, -4.6], [-2.8, 4.3, 0.2], [-1.7, 3.55, -1.45], [-1.55, 2.45, -1.85], [2.05, -0.05, -3.35], [-1.45, 0.95, 1.25], [0.05, 1.1, 1.9], [-0.45, 0.8, -0.55], [-4.05, 3.8, -3.75], [0.85, 2.4, -2.3], [-0.95, 1.7, -1.85], [-1.4, 0.9, -1.85], [-0.15, 0.9, -1.5], [-1.35, -4.15, 4.2], [1.7, 0.55, -2.7], [2.2, -3.8, 1.1], [2.35, -3.1, 1.15], [2.05, -3.45, 1.95], [1.9, -4, 0.15], [1.55, -4.1, 2.15], [-2.5, -4.9, 2], [-2.9, -4.3, 0.1], [-3.1, -4.95, -1.45], [0.1, -4.05, 4.7], [0.15, -4.8, 3.2], [-1.7, -3.6, 3.5], [-2.4, -4.1, 2.65], [-1.25, -4.9, 2.4], [1.5, -0.15, 1], [0.75, 0.8, 0.6], [1, 0.3, 2.35], [1.55, -0.75, 0.55], [1.4, -1.3, -3.4], [1.15, -0.4, -3.3], [1.5, -0.8, -1.9], [0.9, 0.15, -2], [1.7, -1.5, -2.2], [-2.2, 3.05, -0.15], [-1.35, -3.35, -2.35], [-2.35, -2.35, -2.65], [-1.3, -2.5, -3.75], [1.9, -0.95, 1.6], [1.6, -0.85, 2.55], [1.5, -2.4, -1.55], [1.5, -2.15, -2.9], [2.3, -1.75, 1.75], [2.45, -2.35, 0.9], [-1.15, -1.75, -4.2], [0.15, -1.9, -4.25], [1.85, -4.8, -2.35], [1.2, -3.95, -1.8], [1.55, -4.75, -1.25], [0.9, -3.45, 3.6], [0.8, -4.2, 3.8], [-1.8, 2.9, 0.35], [-3, 3.65, 0.7], [0.7, 0.35, -0.8], [1.5, -1.15, -1.25], [1.4, -2, -0.75], [1.05, -3.6, -0.55], [1.6, -0.85, -0.4], [0.05, -4.9, -2.75], [-0.05, -4.15, -1.95], [0.85, -4.3, -2.85], [0.25, -2.6, 4], [2.25, -1.2, 0.15], [-3.85, 2.35, -2.9], [-4.95, 3.35, -2.6], [-4.35, 2.45, -3.15], [2.3, -1.95, -0.25], [2.1, -3.1, 0.15], [0.3, -1.4, 3.9], [1.05, 1.45, -2.65], [1.45, -4.75, 2.3], [-0.75, 2.65, -1.5], [-0.4, 2.55, -2.05], [-1.6, 4.25, -0.45], [0.65, 1.35, -2], [-1.2, 0.85, -4.3], [-0.1, 1.45, -4.4], [0.45, 0.5, -4.65], [1.85, -2, 2.7], [-0.95, -0.95, 3.95], [1.3, -1.5, 3.35], [-2.4, 4.05, 0.2], [2.15, -4.85, -0.35], [1.7, -3.35, 2.55], [-0.55, -3.55, -2.25], [-0.75, -4, -2.4], [2.2, -4.3, -0.5], [0.6, 0, 3.2], [0.9, -3.15, -2], [-1.65, 1.75, -2.75], [-0.95, -2.55, 4.05], [-2.25, -1.65, 3.45], [-2.45, -2.45, 3.05], [-2.7, -3.85, -0.5], [-3, -4.3, -1], [-0.1, -4.9, -0.65], [0.95, -4.85, -0.85], [-0.2, -4.7, -0.45], [-1.85, -0.4, 3.2], [-1.6, 1.8, -3.5], [-0.05, 2.2, -4.55], [-1.5, 2.35, -3.6], [-3.2, -1.25, 1.45], [-2.6, -0.95, 2.3], [-2.85, -3.65, 2.45], [-1.1, 2.45, -2.65], [-1.15, 0.4, 3], [0.65, -2.6, -3.6], [-2.1, -2.8, -1.8], [0.4, 2.65, -3.45], [-4.85, 4.2, -2.95], [-1.8, -1.4, -3.9], [0.1, -3.4, -2.35], [0, -3.6, -2], [-2.7, -1, -0.2], [-2.6, -1.6, -1.25], [-2.9, -2.1, -0.95], [-1.85, -3.8, -0.8], [1.45, 0.05, -4.55], [1.4, -4.9, -0.75], [1.25, -4.85, -2.95], [-2.45, -0.3, -0.35], [-2.45, -0.5, -1.4], [-3.55, -3, 0.05], [-3.4, -1.45, -0.45], [-0.8, -4.55, -3.35], [-1.9, -4.6, 1.5], [-0.95, -4.7, -0.65], [-1.5, -4.95, -3.25], [-2, -4.95, -1.9], [-1.55, -4.05, -2.15], [-3.85, 3.25, -3.35], [-1.6, 0.45, -0.45], [-2.8, 2.2, -3.45], [-2.3, 0.2, 1.55], [-2.05, -4.9, 1.85], [-2.4, -4.85, -0.9], [-2.55, -0.8, 1.45], [0.5, -4.95, -1.5], [-3.65, -1.85, 0.35], [-1.75, 0.35, -2.75], [-2.45, -0.7, -2.35], [-1.85, 0.65, -1.5], [1.15, -4.65, -0.5], [0.1, -4.85, -1], [-0.6, -4.95, -0.85], [-1.2, -4.7, -0.85], [-3.15, -2.7, 1.9], [-3.1, -3.9, 1.25], [0.4, -4.9, 1.65], [1.15, -4.95, 1.6], [0, -4.85, 1.7], [0.2, -4.9, 2.3], [1.45, -4.8, 0.55], [1.6, -4.9, 0.15], [0.85, -4.6, 1.6], [-0.5, -4.75, 0.9], [1.3, -4.9, 1.1], [-0.45, -4.9, 2.55], [-0.85, -4.8, 2.35], [1.1, -4.6, 0.85], [-0.95, -4.75, 1.65], [-0.25, -3.3, -3.15], [-0.3, -4.95, -2.15], [-1.3, -5, -1.35], [0.45, -4.9, -1.95], [1.25, -4.6, 0.35], [-1.5, -4.75, -1.05], [-0.95, -4.95, -1.15], [-0.65, -4.85, -1.8], [-0.45, -4.9, -1.25]];
var bunfaces = [[0,1,2],[3,4,5],[6,7,8],[9,10,11],[12,8,7],[13,14,15],[9,11,16],[17,18,19],[5,4,20],[10,21,11],[22,23,24],[1,25,2],[11,26,16],[27,28,29],[30,27,31],[32,33,34],[35,25,36],[37,38,39],[40,41,42],[40,42,43],[44,45,46],[45,47,46],[44,46,48],[41,19,18],[49,13,15],[50,51,52],[53,42,54],[48,55,56],[53,57,58],[59,6,60],[26,47,45],[58,57,28],[46,55,48],[61,62,63],[64,65,36],[66,67,49],[46,47,68],[47,24,68],[46,69,55],[46,68,69],[62,55,70],[62,71,63],[62,70,71],[69,70,55],[28,57,29],[69,68,72],[69,72,70],[73,74,75],[53,54,57],[72,68,41],[19,41,68],[64,76,0],[65,64,0],[43,72,40],[40,72,41],[77,53,58],[78,79,80],[81,58,82],[77,58,81],[43,42,53],[82,27,30],[27,82,28],[58,28,82],[83,76,64],[45,16,26],[11,84,26],[11,21,84],[35,2,25],[31,64,85],[86,87,88],[26,84,89],[90,91,92],[93,29,57],[84,21,89],[85,64,36],[26,89,47],[83,94,76],[0,35,65],[54,95,93],[89,24,47],[13,49,67],[66,86,96],[86,88,96],[97,30,31],[29,98,31],[50,99,100],[87,86,22],[93,98,29],[101,30,97],[93,95,64],[102,83,95],[98,93,64],[64,95,83],[54,102,95],[86,66,22],[24,89,22],[98,64,31],[31,27,29],[74,103,62],[104,3,78],[105,106,107],[108,109,33],[110,111,112],[39,38,32],[94,113,106],[90,92,12],[114,115,91],[114,116,115],[3,79,78],[117,106,118],[37,119,38],[105,94,106],[120,3,104],[115,10,91],[90,114,91],[37,107,119],[105,107,37],[74,73,100],[121,18,17],[96,67,66],[83,102,94],[89,21,22],[76,94,105],[0,2,35],[87,22,21],[52,60,122],[121,113,94],[1,0,76],[1,76,105],[123,51,50],[21,10,124],[4,124,116],[87,124,120],[68,24,19],[120,4,3],[87,21,124],[10,115,124],[120,124,4],[102,121,94],[96,13,67],[124,115,116],[5,125,79],[102,18,121],[96,88,13],[53,77,43],[22,49,15],[102,42,18],[5,79,3],[19,24,23],[126,6,59],[42,41,18],[5,20,125],[61,75,62],[127,103,128],[70,72,81],[55,62,103],[48,56,44],[71,82,30],[103,74,128],[20,4,116],[30,101,71],[72,77,81],[43,77,72],[129,130,131],[130,123,132],[63,71,101],[9,16,133],[70,81,71],[99,128,74],[81,82,71],[61,63,134],[135,75,61],[8,45,44],[6,44,60],[6,8,44],[136,137,130],[10,9,133],[136,130,129],[138,139,131],[88,87,120],[100,73,140],[60,44,56],[99,74,100],[141,142,112],[143,144,145],[20,146,125],[125,146,80],[91,10,92],[17,19,147],[138,131,108],[146,116,80],[74,62,75],[131,139,129],[146,20,116],[148,80,116],[108,132,109],[130,132,108],[118,106,113],[34,109,132],[148,116,114],[13,88,14],[14,88,120],[66,49,22],[17,136,149],[10,133,92],[140,145,100],[141,150,151],[59,60,52],[145,50,100],[126,7,6],[90,12,7],[104,22,120],[121,149,113],[139,117,152],[153,134,111],[139,154,117],[149,152,113],[155,156,157],[155,157,23],[136,17,147],[117,118,152],[152,118,113],[104,23,22],[157,156,137],[139,152,129],[19,23,157],[102,54,42],[149,121,17],[112,111,158],[159,110,160],[157,136,147],[157,137,136],[157,147,19],[155,7,156],[155,114,90],[155,90,7],[105,37,1],[25,1,37],[104,155,23],[130,51,123],[80,79,125],[156,7,126],[51,156,126],[37,39,25],[132,123,145],[132,145,144],[153,111,110],[54,93,57],[141,161,142],[107,162,119],[162,107,106],[132,144,34],[38,119,32],[106,117,162],[31,85,97],[59,52,126],[162,163,119],[163,33,119],[32,119,33],[162,138,163],[162,117,154],[14,120,15],[154,138,162],[22,15,120],[149,129,152],[163,138,33],[137,156,130],[145,140,143],[32,151,150],[33,109,34],[104,114,155],[123,50,145],[33,138,108],[51,126,52],[138,154,139],[130,156,51],[131,130,108],[153,110,159],[164,165,85],[166,164,167],[78,80,104],[80,148,104],[164,85,167],[97,85,165],[168,169,97],[165,164,170],[164,171,170],[168,97,172],[92,8,12],[173,167,36],[63,97,134],[92,133,8],[39,173,36],[167,85,36],[150,171,39],[174,173,39],[171,175,170],[141,112,171],[176,174,39],[133,45,8],[134,97,169],[39,36,25],[122,177,52],[45,133,16],[122,60,56],[32,150,39],[177,50,52],[171,176,39],[104,148,114],[143,140,73],[50,177,99],[97,63,101],[129,149,136],[172,97,165],[143,73,144],[122,103,177],[177,127,99],[177,103,127],[122,56,103],[144,73,178],[135,73,75],[171,166,176],[34,144,151],[144,178,179],[151,144,179],[73,135,178],[135,180,178],[135,61,180],[171,181,175],[179,182,151],[179,178,183],[184,160,178],[56,55,103],[183,178,160],[184,185,160],[112,158,171],[158,181,171],[171,150,141],[32,34,151],[151,182,161],[153,180,134],[180,61,134],[141,151,161],[171,164,166],[36,65,35],[185,159,160],[128,99,127],[134,158,111],[169,158,134],[158,169,181],[169,168,181],[181,168,175],[168,172,175],[175,172,170],[165,170,172],[182,179,183],[161,182,183],[183,160,161],[161,160,142],[112,142,160],[160,110,112]];
function matrix_vector_multiply(M,v) {
	var rval = [];
	var i, j;
	var sum;
	for (i = 0; i < M.length; i++) {
		sum = 0;
		for (j = 0; j < v.length; j++) {
			sum += M[i][j] * v[j];
			}
		rval.push(sum);
		}
	return(rval);
	}

function matrix_matrix_multiply(M1,M2) {
	var rval = [];
	var i;
	if (M2.length != M1[0].length) {console.log("matrix dimension error");}
	for (i = 0; i < M1.length; i++) {
		var trow = [];
		for (j = 0; j < M2[0].length; j++) {
			var sum = 0;
			for (k = 0; k < M2.length; k++) {
				sum += M1[i][k] * M2[k][j];
				}
			trow.push(sum);
			}
		rval.push(trow);
		}
	return(rval);
	}

function project(v) {
	var k = Number(document.getElementById("pd").value)
	return([v[0]/(k*v[2]),v[1]/(k*v[2])]);
	//return([v[0],v[1]]);
	}

function to_canvas(v) {
	return([100+v[0]*100,100-v[1]*100]);
	}

function un_to_canvas(v) {
	return([v[0]/100 - 1, 1 - v[1]/100]);
	}

function add_vectors(v1,v2) {
	var i;
	var rval = [];
	for (i = 0; i < v1.length; i++) {
		rval.push(v1[i]+v2[i]);
		}
	return(rval);
	}

function subtract_vectors(v1,v2) {
	var i;
	var rval = [];
	for (i = 0; i < v1.length; i++) {
		rval.push(v1[i]-v2[i]);
		}
	return(rval);
	}

function scalar_multiply(s,v1) {
	var i;
	var rval = [];
	for (i = 0; i < v1.length; i++) {
		rval.push(s*v1[i]);
		}
	return(rval);
	}

function rotation_matrix_y(theta) {
	return([
		[Math.cos(theta),0,-Math.sin(theta)],
		[0,1,0],
		[Math.sin(theta),0,Math.cos(theta)],
		]);
	}

function rotation_matrix_x(theta) {
	return([
		[1,0,0],
		[0,Math.cos(theta),-Math.sin(theta)],
		[0,Math.sin(theta),Math.cos(theta)],
		]);
	}

function cross_product(a,b) {
	return([
		a[1]*b[2]-a[2]*b[1],
		a[2]*b[0]-a[0]*b[2],
		a[0]*b[1]-a[1]*b[0]
		]);
	}

function dot_product(a,b) {
	var sum = 0;
	var i;
	for (i = 0; i < a.length; i++) {
		sum += a[i]*b[i];
		}
	return(sum);
	}

function vector_length(a) {
	var sum = 0;
	var i;
	for (i = 0; i < a.length; i++) {
		sum += a[i]*a[i];
		}
	return(Math.sqrt(sum));
	}

function vector_length_sq(a) {
	return(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);
	}

function triplelinearcomb(a,v1,b,v2,c,v3) {
	var rval = [];
	var i;
	for (i = 0; i < v1.length; i++) {
		rval.push(a*v1[i]+b*v2[i]+c*v3[i]);
		}
	return(rval);
	}

function normalize(a) {
	return(scalar_multiply(1/vector_length(a),a));
	}

function visible_square(v1,v2,v3,v4) {
	var center = scalar_multiply(.5,add_vectors(v1,v3));
	var normal = cross_product(subtract_vectors(v1,v2),subtract_vectors(v3,v2));
	var chat = normalize(center);
	var nhat = normalize(normal);
	if (dot_product(chat,nhat) < 0) {return(false);}
	return(true);
	}

function invertmatrix(m) {
	var a = m[0][0];
	var b = m[0][1];
	var c = m[0][2];
	var d = m[1][0];
	var e = m[1][1];
	var f = m[1][2];
	var g = m[2][0];
	var h = m[2][1];
	var i = m[2][2];
	var dr = 1/(a*e*i+b*f*g+c*d*h-g*e*c-h*f*a-i*d*b);
	return([[dr*(e*i-f*h),dr*(c*h-b*i),dr*(b*f-c*e)],
		[dr*(f*g-d*i),dr*(a*i-c*g),dr*(c*d-a*f)],
		[dr*(d*h-e*g),dr*(b*g-a*h),dr*(a*e-b*d)]]);
	}

function solvesquare(v1,v2,v3,v4,x,y) {
	//solve when project(v1+b*(v2-v1)+c*(v4-v1)) = (x,y);
	var k = Number(document.getElementById("pd").value)
	//return([v[0]/(k*v[2]),v[1]/(k*v[2])]);
	var m = [
		[v2[0]-v1[0],v4[0]-v1[0],x*k],
		[v2[1]-v1[1],v4[1]-v1[1],y*k],
		[v2[2]-v1[2],v4[2]-v1[2],1]];
	var vecans = matrix_vector_multiply(invertmatrix(m),scalar_multiply(-1,v1));
	return(vecans);
	}

var g_mat = rotation_matrix_y(.8);
var g_mousestate = 0;

function mm(e) {
	if (g_mousestate) {
		g_mat = matrix_matrix_multiply(rotation_matrix_y(.01*e.movementX),g_mat);
		g_mat = matrix_matrix_multiply(rotation_matrix_x(-.01*e.movementY),g_mat);
		draw_cube();
		}
	}

var zbuffer = [];

function renderface(ctx,i,v1,v2,v3) {
	var pv1 = to_canvas(project(v1));
	var pv2 = to_canvas(project(v2));
	var pv3 = to_canvas(project(v3));
	var minx = Math.min(pv1[0],pv2[0],pv3[0]);
	var maxx = Math.max(pv1[0],pv2[0],pv3[0]);
	var miny = Math.min(pv1[1],pv2[1],pv3[1]);
	var maxy = Math.max(pv1[1],pv2[1],pv3[1]);
	for (x = Math.floor(minx); x <= maxx; x++) {
		for (y = Math.floor(miny); y <= maxy; y++) {
			var t = solvesquare(v1,v2,v3,v3,...un_to_canvas([x,y]));
			if (t[0] > 0 && t[1] > 0 && t[0]+t[1] < 1) {
				var j = vector_length_sq(triplelinearcomb(1-t[0]-t[1],v1,t[0],v2,t[1],v3));
				if (zbuffer[x][y] > j) {
					zbuffer[x][y] = j;
					var k = 100-Math.floor(Math.min(Math.max(j,0),100));
					ctx.fillStyle = "hsla("+i+","+k+"%,50%,1)";
					ctx.fillRect(x,y,1,1);
					}
				}
			}
		}
	}

function draw_cube() {
	var x,y;
	zbuffer = [];
	for (x = 0; x < 200; x++) {
		zbuffer.push([]);
		for (y = 0; y < 200; y++) {
			zbuffer[x].push(Infinity);
			}
		}
	var i,j;
	var ctx = document.getElementById("canvas").getContext("2d");
	ctx.strokeStyle = "black";
	ctx.lineWidth = 1;
	ctx.clearRect(0,0,500,500);
	ctx.lineCap = "round";
	ctx.lineJoin = "round";
	var verts = [];
	for (i = 0; i < bunverts.length; i++) {
		verts.push(matrix_vector_multiply(g_mat,bunverts[i]));	
		verts[i] = add_vectors(verts[i],[0,0,10]);
		}
	var faces = bunfaces;
	var colors = [
		"hsla(0,100%,50%,.5)",
		"hsla(60,100%,50%,.5)",
		"hsla(120,100%,50%,.5)",
		"hsla(180,100%,50%,.5)",
		"hsla(240,100%,50%,.5)",
		"hsla(300,100%,50%,.5)",
		];

	for (i = 0; i < faces.length; i++) {
		if (visible_square(verts[faces[i][0]],verts[faces[i][1]],verts[faces[i][2]],verts[faces[i][0]])) {
			renderface(ctx,i,verts[faces[i][0]],verts[faces[i][1]],verts[faces[i][2]]);
			}
		}
/*	for (i = 0; i < faces.length; i++) {
		ctx.beginPath();
		ctx.moveTo(...to_canvas(project(verts[faces[i][0]])));
		for (j = 0; j < faces[i].length; j++) {
			ctx.lineTo(...to_canvas(project(verts[faces[i][j]])));
			}
		ctx.lineTo(...to_canvas(project(verts[faces[i][0]])));
		if (!visible_square(verts[faces[i][0]],verts[faces[i][1]],verts[faces[i][2]],verts[faces[i][0]])) {
			ctx.stroke();
			}
		}*/
	}

function readpixel(data,x,y) {
	var i = ((Math.floor(y)%275)*275+(Math.floor(x)%275))*4;
	var r = data[i];
	var g = data[i+1];
	var b = data[i+2];
	var a = data[i+3];
	return([r,g,b]);
	}

function drawpixel(ctx,color,x,y) {
	ctx.fillStyle = "rgba("+color[0]+","+color[1]+","+color[2]+",1)";
	ctx.fillRect(x-2,y-2,4,4);
	}

function boot() {
	draw_cube();
	}


</script>
</head>
<body onload="boot()" onmousedown="g_mousestate=1" onmouseup="g_mousestate=0">

The fluffy cat is drawn by iterating over pixels in the texture image
<br>The scratching post cat is drawn by iterating over pixels in the canvas using nearest neighbor
<br>Click and drag in the canvas to rotate

<canvas id="canvas" width=200 height=200 style='border:1px solid' onmousemove="mm(event)"></canvas>
<br>
<input id="pd" type="number" oninput="draw_cube()" value=1 step=.01>


</body>
</html>